ALTER TABLE BOOKS ADD BESTSELLER BOOLEAN;


DROP FUNCTION IF EXISTS SetBestseller;

DELIMITER $$
CREATE FUNCTION SetBestseller(numofrents DECIMAL) RETURNS BOOLEAN DETERMINISTIC
BEGIN
  DECLARE result BOOLEAN DEFAULT FALSE;
   IF (numofrents > 2) THEN
     SET result = TRUE;
   END IF;  
RETURN result;
END $$
DELIMITER ;


DROP PROCEDURE IF EXISTS UpdateBestsellers;

DELIMITER $$

CREATE PROCEDURE UpdateBestsellers()
BEGIN
 DECLARE BOOKSRENT, BK_ID, DAYS INT;
 DECLARE RENTSPERMONTH DECIMAL(5,2);
 DECLARE ISBESTSELLER BOOLEAN;
 DECLARE FINISHED INT DEFAULT 0;
 DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
 DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
 OPEN ALL_BOOKS;
 WHILE (FINISHED = 0) DO
    FETCH ALL_BOOKS INTO BK_ID;
      IF (FINISHED = 0) THEN
        SELECT COUNT(*) FROM RENTS
        WHERE BOOK_ID = BK_ID 
        INTO BOOKSRENT;
        SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) + 1 FROM RENTS
        WHERE BOOK_ID = BK_ID
        INTO DAYS;
        SET RENTSPERMONTH = BOOKSRENT / DAYS * 30;
        UPDATE BOOKS SET BESTSELLER = SetBestseller(RENTSPERMONTH)
        WHERE BOOK_ID = BK_ID;
       COMMIT;
     END IF;
END WHILE;
CLOSE ALL_BOOKS;
END $$
DELIMITER ;


CALL UpdateBestsellers;
SELECT * FROM BOOKS;